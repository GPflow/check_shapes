
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>check_shapes User Guide &#8212; check_shapes 1.1.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Benchmark results" href="benchmarks.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="check-shapes-user-guide">
<h1>check_shapes User Guide<a class="headerlink" href="#check-shapes-user-guide" title="Permalink to this heading">¶</a></h1>
<p>A library for annotating and checking the shapes of tensors.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://gpflow.github.io/check_shapes/index.html">Documentation for most recent release</a></p></li>
<li><p><a class="reference external" href="https://gpflow.github.io/check_shapes/develop/index.html">Documentation for current development version</a></p></li>
</ul>
<div class="toctree-wrapper compound">
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="benchmarks.html">Benchmark results</a></li>
<li class="toctree-l1"><a class="reference internal" href="autoapi/check_shapes/index.html">API reference</a></li>
</ul>
</div>
<p>The main entry point is <a class="reference internal" href="autoapi/check_shapes/index.html#module-check_shapes" title="check_shapes"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_shapes()</span></code></a>.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">check_shapes</span> <span class="kn">import</span> <span class="n">check_shapes</span>

<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;features: [batch..., n_features]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;weights: [n_features]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: [batch...]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">linear_model</span><span class="p">(</span><span class="n">features</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;...i,i -&gt; ...&quot;</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>

</pre></div>
</div>
<p>Main features include:</p>
<ul class="simple">
<li><p>Supports NumPy, TensorFlow, JAX and PyTorch out-of-the-box, and easy to extend to other
frameworks.</p></li>
<li><p>Checking the shapes of function arguments and return types, using a decorator.</p></li>
<li><p>Checking the shapes of local values, using a function.</p></li>
<li><p>Constant- and variable size dimensions.</p></li>
<li><p>Constant- and variable rank tensors.</p></li>
<li><p>Broadcasting.</p></li>
<li><p>Conditional shapes.</p></li>
<li><p>Reuse of shape specifications, including in class inheritance.</p></li>
<li><p>Automatic rewrite of docstrings to include shape information.</p></li>
</ul>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">check_shapes</span></code> can be installed with <code class="docutils literal notranslate"><span class="pre">pip</span></code> as usual:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">check_shapes</span>
</pre></div>
</div>
</section>
<section id="speed-and-interactions-with-tf-function">
<h2>Speed, and interactions with <cite>tf.function</cite><a class="headerlink" href="#speed-and-interactions-with-tf-function" title="Permalink to this heading">¶</a></h2>
<p>Shape checking has some performance impact. For estimates of this impact see our <a class="reference internal" href="benchmarks.html"><span class="doc">Benchmark results</span></a>
page. If the overhead is unacceptable shape checking can be disabled.
Shape checking can be set to one of three different states:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ENABLED</span></code>. Shapes are checked wherever they can be.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EAGER_MODE_ONLY</span></code>. Shapes are not checked within anything wrapped in <code class="xref py py-func docutils literal notranslate"><span class="pre">tf.function()</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DISABLED</span></code>. Shapes are never checked.</p></li>
</ul>
<p>The state can be set with <code class="xref py py-func docutils literal notranslate"><span class="pre">set_enable_check_shapes()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="n">set_enable_check_shapes</span><span class="p">(</span><span class="n">ShapeCheckingState</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">)</span>

</pre></div>
</div>
<p>Alternatively you can use <code class="xref py py-func docutils literal notranslate"><span class="pre">disable_check_shapes()</span></code> to disable shape checking in smaller scopes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="k">with</span> <span class="n">disable_check_shapes</span><span class="p">():</span>
    <span class="n">performance_sensitive_function</span><span class="p">()</span>

</pre></div>
</div>
<p>Beware that any function declared while shape checking is disabled, will continue not to check
shapes, even if shape checking is otherwise enabled again.</p>
<p>The default state is <code class="docutils literal notranslate"><span class="pre">EAGER_MODE_ONLY</span></code>; which is appropriate for smaller project, experiments, and
notebooks. Write and debug your code in eager mode, and add <code class="xref py py-func docutils literal notranslate"><span class="pre">tf.function()</span></code> when you believe
your code is correct and you want it to run fast. For larger project you probably want to modify
this setting. In particular you may want to enable all shape checks in your unit tests. If you use
<a class="reference external" href="https://docs.pytest.org/">pytest</a> you can do this by updating your root <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">enable_shape_checks</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
    <span class="n">old_enable</span> <span class="o">=</span> <span class="n">get_enable_check_shapes</span><span class="p">()</span>
    <span class="n">old_rewrite_docstrings</span> <span class="o">=</span> <span class="n">get_rewrite_docstrings</span><span class="p">()</span>
    <span class="n">old_function_call_precompute</span> <span class="o">=</span> <span class="n">get_enable_function_call_precompute</span><span class="p">()</span>
    <span class="n">set_enable_check_shapes</span><span class="p">(</span><span class="n">ShapeCheckingState</span><span class="o">.</span><span class="n">ENABLED</span><span class="p">)</span>
    <span class="n">set_rewrite_docstrings</span><span class="p">(</span><span class="n">DocstringFormat</span><span class="o">.</span><span class="n">SPHINX</span><span class="p">)</span>
    <span class="n">set_enable_function_call_precompute</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">yield</span>
    <span class="n">set_enable_function_call_precompute</span><span class="p">(</span><span class="n">old_function_call_precompute</span><span class="p">)</span>
    <span class="n">set_rewrite_docstrings</span><span class="p">(</span><span class="n">old_rewrite_docstrings</span><span class="p">)</span>
    <span class="n">set_enable_check_shapes</span><span class="p">(</span><span class="n">old_enable</span><span class="p">)</span>

</pre></div>
</div>
<p>If shape checking is set to <code class="docutils literal notranslate"><span class="pre">ENABLED</span></code> and your code is wrapped in <code class="xref py py-func docutils literal notranslate"><span class="pre">tf.function()</span></code> shape checks
are performed while tracing graphs, but <em>not</em> compiled into the actual graphs.  This is considered a
feature as that means that <a class="reference internal" href="autoapi/check_shapes/index.html#module-check_shapes" title="check_shapes"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_shapes()</span></code></a> doesn’t impact the execution speed of your functions
after they have been compiled.</p>
</section>
<section id="best-effort-checking">
<h2>Best-effort checking<a class="headerlink" href="#best-effort-checking" title="Permalink to this heading">¶</a></h2>
<p>This library will perform shape checks on a best-effort basis. Many things can prevent this library
from being able to check shapes. For example:</p>
<ul class="simple">
<li><p>Unknown shapes. Sometimes the library is not able to determine the shape of an object, and thus
cannot check that object. For example <code class="docutils literal notranslate"><span class="pre">Optional</span></code> arguments with value <code class="docutils literal notranslate"><span class="pre">None</span></code> cannot be
checked, and compiled TensorFlow code can have variables with an unknown shape.</p></li>
<li><p>Use of variable-rank dimensions (see below). In general we cannot infer the size of variable-rank
dimensions if there are multiple variable-rank specifications within the same shape specification
(e.g. <code class="docutils literal notranslate"><span class="pre">cov:</span> <span class="pre">[m...,</span> <span class="pre">n...]</span></code>). This library will try to learn the size of these variable-rank
dimensions from neighbouring shape specifications, but this is not always possible. Use of
<code class="docutils literal notranslate"><span class="pre">broadcast</span></code> with variable-rank dimensions makes it even harder to infer these values.</p></li>
</ul>
</section>
<section id="check-specification">
<h2>Check specification<a class="headerlink" href="#check-specification" title="Permalink to this heading">¶</a></h2>
<p>The shapes to check are specified by the arguments to <a class="reference internal" href="autoapi/check_shapes/index.html#module-check_shapes" title="check_shapes"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_shapes()</span></code></a>. Each argument is a
string of the format:</p>
<div class="highlight-bnf notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nc">argument specifier</span><span class="p">&gt;</span> &quot;:&quot; <span class="p">&lt;</span><span class="nc">shape specifier</span><span class="p">&gt;</span> [&quot;if&quot; <span class="p">&lt;</span><span class="nc">condition</span><span class="p">&gt;</span>] [&quot;#&quot; <span class="p">&lt;</span><span class="nc">note</span><span class="p">&gt;</span>]
</pre></div>
</div>
<section id="argument-specification">
<h3>Argument specification<a class="headerlink" href="#argument-specification" title="Permalink to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">&lt;argument</span> <span class="pre">specifier&gt;</span></code> must start with either the name of an argument to the decorated
function, or the special name <code class="docutils literal notranslate"><span class="pre">return</span></code>. The value <code class="docutils literal notranslate"><span class="pre">return</span></code> refers to the value returned by the
function.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">&lt;argument</span> <span class="pre">specifier&gt;</span></code> can then be modified to refer to elements of the object in several
ways:</p>
<ul>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">.&lt;name&gt;</span></code> to refer to an attribute of an object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Statistics</span><span class="p">:</span>
    <span class="n">mean</span><span class="p">:</span> <span class="n">ndarray</span>
    <span class="n">std</span><span class="p">:</span> <span class="n">ndarray</span>

<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;data: [n_rows, n_columns]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return.mean: [n_columns]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return.std: [n_columns]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">compute_statistics</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Statistics</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Statistics</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

</pre></div>
</div>
</li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">[&lt;index&gt;]</span></code> to refer to a specific element of a sequence. This is particularly useful if
your function returns a tuple of values:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;data: [n_rows, n_columns]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return[0]: [n_columns]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return[1]: [n_columns]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">compute_mean_and_std</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

</pre></div>
</div>
</li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">[all]</span></code> to select all elements of a collection:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;data[all]: [., n_columns]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: [., n_columns]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">concat_rows</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">concat_rows</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
    <span class="p">]</span>
<span class="p">)</span>

</pre></div>
</div>
</li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">.keys()</span></code> to select all keys of a mapping:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;data.keys(): [.]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: []&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">sum_key_lengths</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>

<span class="n">sum_key_lengths</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="p">(</span><span class="mi">3</span><span class="p">,):</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="s2">&quot;bar&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>

</pre></div>
</div>
</li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">.values()</span></code> to select all values of a mapping:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;data.values(): [., n_columns]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: [., n_columns]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">concat_rows</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">concat_rows</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;foo&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
        <span class="s2">&quot;bar&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
    <span class="p">}</span>
<span class="p">)</span>

</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We do not support looking up a specific key or value in a  <code class="docutils literal notranslate"><span class="pre">dict</span></code>.</p>
</div>
<p>If the argument, or any of the looked-up values, are <code class="docutils literal notranslate"><span class="pre">None</span></code> the check is skipped. This is useful
for optional values:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;x1: [n_rows_1, n_inputs]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;x2: [n_rows_2, n_inputs]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: [n_rows_1, n_rows_2]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">squared_exponential_kernel</span><span class="p">(</span>
    <span class="n">variance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">x2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">x1</span>
    <span class="n">cov</span><span class="p">:</span> <span class="n">ndarray</span> <span class="o">=</span> <span class="n">variance</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
        <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">x2</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">cov</span>

<span class="n">squared_exponential_kernel</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">squared_exponential_kernel</span><span class="p">(</span><span class="mf">3.2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

</pre></div>
</div>
</section>
<section id="shape-specification">
<h3>Shape specification<a class="headerlink" href="#shape-specification" title="Permalink to this heading">¶</a></h3>
<p>Shapes are specified by the syntax:</p>
<div class="highlight-bnf notranslate"><div class="highlight"><pre><span></span>&quot;[&quot; <span class="p">&lt;</span><span class="nc">dimension specifier 1</span><span class="p">&gt;</span> &quot;,&quot; <span class="p">&lt;</span><span class="nc">dimension specifer 2</span><span class="p">&gt;</span> &quot;,&quot; ... &quot;,&quot; <span class="p">&lt;</span><span class="nc">dimension specifier n</span><span class="p">&gt;</span> &quot;]&quot;
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">&lt;dimension</span> <span class="pre">specifier</span> <span class="pre">i&gt;</span></code> is one of:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;integer&gt;</span></code>, to require that dimension to have that exact size:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;v1: [2]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;v2: [2]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">vector_2d_distance</span><span class="p">(</span><span class="n">v1</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">v2</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">v1</span> <span class="o">-</span> <span class="n">v2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span>

</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;name&gt;</span></code>, to bind that dimension to a variable. Dimensions bound to the same variable must
have the same size, though that size can be anything:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;v1: [d]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;v2: [d]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">vector_distance</span><span class="p">(</span><span class="n">v1</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">v2</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">v1</span> <span class="o">-</span> <span class="n">v2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span>

</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">None</span></code> or <code class="docutils literal notranslate"><span class="pre">.</span></code> to allow exactly one single dimension without constraints:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;v: [None]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">vector_length</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span>

</pre></div>
</div>
<p>or:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;v: [.]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">vector_length</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span>

</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">*&lt;name&gt;</span></code> or <code class="docutils literal notranslate"><span class="pre">&lt;name&gt;...</span></code>, to bind <em>any</em> number of dimensions to a variable. Again,
multiple uses of the same variable name must match the same dimension sizes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;x: [*batch, n_columns]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: [*batch]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">batch_mean</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
    <span class="n">mean</span><span class="p">:</span> <span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mean</span>

</pre></div>
</div>
<p>or:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;x: [batch..., n_columns]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: [batch...]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">batch_mean</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
    <span class="n">mean</span><span class="p">:</span> <span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mean</span>

</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">*</span></code> or <code class="docutils literal notranslate"><span class="pre">...</span></code>, to allow <em>any</em> number of dimensions without constraints:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;x: [*]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">rank</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

</pre></div>
</div>
<p>or:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;x: [...]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">rank</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

</pre></div>
</div>
</li>
</ul>
<p>A scalar shape is specified by <code class="docutils literal notranslate"><span class="pre">[]</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;x: [...]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: []&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
    <span class="n">mean</span><span class="p">:</span> <span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span>
    <span class="k">return</span> <span class="n">mean</span>

</pre></div>
</div>
<p>Any of the above can be prefixed with the keyword <code class="docutils literal notranslate"><span class="pre">broadcast</span></code> to allow any value that broadcasts
to the specification. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;a: [broadcast batch...]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;b: [broadcast batch...]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: [batch...]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

</pre></div>
</div>
<p>Specifically, to mark a dimension as <code class="docutils literal notranslate"><span class="pre">broadcast</span></code> means:</p>
<ul class="simple">
<li><p>If the specification is that the dimension should have size <code class="docutils literal notranslate"><span class="pre">n</span></code>, then the actual dimension must
have value <code class="docutils literal notranslate"><span class="pre">1</span></code> or <code class="docutils literal notranslate"><span class="pre">n</span></code>.</p></li>
<li><p>If all leading dimension specifications are also marked <code class="docutils literal notranslate"><span class="pre">broadcast</span></code>, then the actual shape is
allowed to be shorter than the specification — the dimension is allowed to be missing.</p></li>
</ul>
</section>
<section id="condition-specification">
<h3>Condition specification<a class="headerlink" href="#condition-specification" title="Permalink to this heading">¶</a></h3>
<p>You can use the optional <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">&lt;condition&gt;</span></code> syntax to conditionally evaluate shapes. If an <code class="docutils literal notranslate"><span class="pre">if</span>
<span class="pre">&lt;condition&gt;</span></code> is used, the specification is only appplied if <code class="docutils literal notranslate"><span class="pre">&lt;condition&gt;</span></code> evaluates to <code class="docutils literal notranslate"><span class="pre">True</span></code>.
This is useful if shapes depend on other input parameters. Valid conditions are:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;argument</span> <span class="pre">specifier&gt;</span></code>, with the same syntax and rules as above, except that constructions that
evaluates to multiple elements are disallowed. Uses the <code class="docutils literal notranslate"><span class="pre">bool</span></code> built-in to convert the value of
the argument to a <code class="docutils literal notranslate"><span class="pre">bool</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;a: [broadcast batch...] if check_a&quot;</span><span class="p">,</span>
    <span class="s2">&quot;b: [broadcast batch...] if check_b&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: [batch...]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">check_a</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">check_b</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

<span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span> <span class="n">check_b</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;argument</span> <span class="pre">specifier&gt;</span> <span class="pre">is</span> <span class="pre">None</span></code>, and <code class="docutils literal notranslate"><span class="pre">&lt;argument</span> <span class="pre">specifier&gt;</span> <span class="pre">is</span> <span class="pre">not</span> <span class="pre">None</span></code>, with the usual rules
for an <code class="docutils literal notranslate"><span class="pre">&lt;argument</span> <span class="pre">specifier&gt;</span></code>, to test whether an argument is, or is not, <code class="docutils literal notranslate"><span class="pre">None</span></code>. We currently
only allow tests against <code class="docutils literal notranslate"><span class="pre">None</span></code>, not general Python equality tests:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;a: [n_a]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;b: [n_b]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: [n_a, n_a] if b is None&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: [n_a, n_b] if b is not None&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">square</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">a</span>
    <span class="n">result</span><span class="p">:</span> <span class="n">ndarray</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,)))</span>
<span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">4</span><span class="p">,)))</span>

</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;left&gt;</span> <span class="pre">or</span> <span class="pre">&lt;right&gt;</span></code>, evaluates to <code class="docutils literal notranslate"><span class="pre">True</span></code> if any of <code class="docutils literal notranslate"><span class="pre">&lt;left&gt;</span></code> or <code class="docutils literal notranslate"><span class="pre">&lt;right&gt;</span></code> evaluates to
<code class="docutils literal notranslate"><span class="pre">True</span></code> and to <code class="docutils literal notranslate"><span class="pre">False</span></code> otherwise:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;a: [broadcast batch...] if check_all or check_a&quot;</span><span class="p">,</span>
    <span class="s2">&quot;b: [broadcast batch...] if check_all or check_b&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: [batch...]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span>
    <span class="n">a</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span>
    <span class="n">b</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span>
    <span class="n">check_all</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">check_a</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">check_b</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

<span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span> <span class="n">check_b</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;left&gt;</span> <span class="pre">and</span> <span class="pre">&lt;right&gt;</span></code>, evaluates to <code class="docutils literal notranslate"><span class="pre">False</span></code> if any of <code class="docutils literal notranslate"><span class="pre">&lt;left&gt;</span></code> or <code class="docutils literal notranslate"><span class="pre">&lt;right&gt;</span></code> evaluates to
<code class="docutils literal notranslate"><span class="pre">False</span></code> and to <code class="docutils literal notranslate"><span class="pre">True</span></code> otherwise:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;a: [broadcast batch...] if enable_checks and check_a&quot;</span><span class="p">,</span>
    <span class="s2">&quot;b: [broadcast batch...] if enable_checks and check_b&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: [batch...]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span>
    <span class="n">a</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span>
    <span class="n">b</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span>
    <span class="n">enable_checks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">check_a</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">check_b</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

<span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span> <span class="n">check_b</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">not</span> <span class="pre">&lt;right&gt;</span></code>, evaluates to the opposite value of <code class="docutils literal notranslate"><span class="pre">&lt;right&gt;</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;a: [broadcast batch...] if not disable_checks&quot;</span><span class="p">,</span>
    <span class="s2">&quot;b: [broadcast batch...] if not disable_checks&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: [batch...]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">disable_checks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

<span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>

</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">(&lt;exp&gt;)</span></code>, uses parenthesis to change operator precedence, as usual.</p></li>
</ul>
<p>Conditions can be composed to apply different specs, depending on function arguments:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;a: [j] if a_vector&quot;</span><span class="p">,</span>
    <span class="s2">&quot;a: [i, j] if (not a_vector)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;b: [j] if b_vector&quot;</span><span class="p">,</span>
    <span class="s2">&quot;b: [j, k] if (not b_vector)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: [1, 1] if a_vector and b_vector&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: [1, k] if a_vector and (not b_vector)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: [i, 1] if (not a_vector) and b_vector&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: [i, k] if (not a_vector) and (not b_vector)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">multiply</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">a_vector</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">b_vector</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">a_vector</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="n">b_vector</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">a</span> <span class="o">@</span> <span class="n">b</span>

<span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">4</span><span class="p">,)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)),</span> <span class="n">a_vector</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">b_vector</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All specifications with either no <code class="docutils literal notranslate"><span class="pre">if</span></code> syntax or a <code class="docutils literal notranslate"><span class="pre">&lt;condition&gt;</span></code> that evaluates to <code class="docutils literal notranslate"><span class="pre">True</span></code>
will be applied. It is possible for multiple specifications to apply to the same value.</p>
</div>
</section>
<section id="note-specification">
<h3>Note specification<a class="headerlink" href="#note-specification" title="Permalink to this heading">¶</a></h3>
<p>You can add notes to your specifications using a <code class="docutils literal notranslate"><span class="pre">#</span></code> followed by the note. These notes will be
appended to relevant error messages and appear in rewritten docstrings. You can add notes in two
places:</p>
<ul>
<li><p>On a single line by itself, to add a note to the entire function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;features: [batch..., n_features]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;# linear_model currently only supports a single output.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;weights: [n_features]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: [batch...]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">linear_model</span><span class="p">(</span><span class="n">features</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
    <span class="n">prediction</span><span class="p">:</span> <span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;...i,i -&gt; ...&quot;</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prediction</span>

</pre></div>
</div>
</li>
<li><p>After the specification of a single argument, to add a note to that argument only:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;features: [batch..., n_features]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;weights: [n_features] # linear_model currently only supports a single output.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: [batch...]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">linear_model</span><span class="p">(</span><span class="n">features</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
    <span class="n">prediction</span><span class="p">:</span> <span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;...i,i -&gt; ...&quot;</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prediction</span>

</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="shape-reuse">
<h2>Shape reuse<a class="headerlink" href="#shape-reuse" title="Permalink to this heading">¶</a></h2>
<p>Just like with other code it is useful to be able to specify a shape in one place and reuse the
specification. In particular this ensures that your code keep having internally consistent shapes,
even if it is refactored.</p>
<section id="class-inheritance">
<h3>Class inheritance<a class="headerlink" href="#class-inheritance" title="Permalink to this heading">¶</a></h3>
<p>If you have a class hiererchy, you probably want to ensure that derived classes handle tensors with
the same shapes as the base classes. You can use the <code class="xref py py-func docutils literal notranslate"><span class="pre">inherit_check_shapes()</span></code> decorator to
inherit shapes from overridden methods:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="nd">@abstractmethod</span>
    <span class="nd">@check_shapes</span><span class="p">(</span>
        <span class="s2">&quot;features: [batch..., n_features]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;return: [batch...]&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="k">class</span> <span class="nc">LinearModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="nd">@check_shapes</span><span class="p">(</span>
        <span class="s2">&quot;weights: [n_features]&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="o">=</span> <span class="n">weights</span>

    <span class="nd">@inherit_check_shapes</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
        <span class="n">prediction</span><span class="p">:</span> <span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;...i,i -&gt; ...&quot;</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prediction</span>

</pre></div>
</div>
</section>
<section id="functional-programming">
<h3>Functional programming<a class="headerlink" href="#functional-programming" title="Permalink to this heading">¶</a></h3>
<p>If you prefer functional- over object oriented programming, you may have functions that you require
to handle the same shapes. To do this, remember that in Python a decorator is just a function, and
functions are objects that can be stored:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="n">check_metric_shapes</span> <span class="o">=</span> <span class="n">check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;actual: [n_rows, n_labels]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;predicted: [n_rows, n_labels]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: []&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="nd">@check_metric_shapes</span>
<span class="k">def</span> <span class="nf">rmse</span><span class="p">(</span><span class="n">actual</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">predicted</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">predicted</span> <span class="o">-</span> <span class="n">actual</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))))</span>

<span class="nd">@check_metric_shapes</span>
<span class="k">def</span> <span class="nf">mape</span><span class="p">(</span><span class="n">actual</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">predicted</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">predicted</span> <span class="o">-</span> <span class="n">actual</span><span class="p">)</span> <span class="o">/</span> <span class="n">actual</span><span class="p">)))</span>

</pre></div>
</div>
</section>
<section id="other-reuse-of-shapes">
<h3>Other reuse of shapes<a class="headerlink" href="#other-reuse-of-shapes" title="Permalink to this heading">¶</a></h3>
<p>You can use <code class="xref py py-func docutils literal notranslate"><span class="pre">get_check_shapes()</span></code> to get, and reuse, the shape definitions from a previously
declared function. This is particularly useful to ensure fakes in tests use the same shapes as the
production implementation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="nd">@abstractmethod</span>
    <span class="nd">@check_shapes</span><span class="p">(</span>
        <span class="s2">&quot;features: [batch..., n_features]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;return: [batch...]&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;test_features: [n_rows, n_features]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;test_labels: [n_rows]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">evaluate_model</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">test_features</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_features</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">prediction</span> <span class="o">-</span> <span class="n">test_labels</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))))</span>

<span class="k">def</span> <span class="nf">test_evaluate_model</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fake_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">fake_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">10</span><span class="p">,))</span>
    <span class="n">fake_predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">10</span><span class="p">,))</span>

    <span class="nd">@get_check_shapes</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">predict</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fake_predict</span><span class="p">(</span><span class="n">features</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">features</span> <span class="ow">is</span> <span class="n">fake_features</span>
        <span class="k">return</span> <span class="n">fake_predictions</span>

    <span class="n">fake_model</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">Model</span><span class="p">,</span> <span class="n">predict</span><span class="o">=</span><span class="n">fake_predict</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="o">==</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">fake_model</span><span class="p">,</span> <span class="n">fake_features</span><span class="p">,</span> <span class="n">fake_labels</span><span class="p">)</span>

</pre></div>
</div>
</section>
</section>
<section id="checking-intermediate-results">
<h2>Checking intermediate results<a class="headerlink" href="#checking-intermediate-results" title="Permalink to this heading">¶</a></h2>
<p>You can use the function <code class="xref py py-func docutils literal notranslate"><span class="pre">check_shape()</span></code> to check the shape of an intermediate result. This
function will use the same namespace as the immediately surrounding <a class="reference internal" href="autoapi/check_shapes/index.html#module-check_shapes" title="check_shapes"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_shapes()</span></code></a> decorator,
and should only be called within functions that has such a decorator. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;weights: [n_features, n_labels]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;test_features: [n_rows, n_features]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;test_labels: [n_rows, n_labels]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: []&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">test_features</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
    <span class="n">prediction</span><span class="p">:</span> <span class="n">ndarray</span> <span class="o">=</span> <span class="n">check_shape</span><span class="p">(</span><span class="n">test_features</span> <span class="o">@</span> <span class="n">weights</span><span class="p">,</span> <span class="s2">&quot;[n_rows, n_labels]&quot;</span><span class="p">)</span>
    <span class="n">error</span><span class="p">:</span> <span class="n">ndarray</span> <span class="o">=</span> <span class="n">check_shape</span><span class="p">(</span><span class="n">prediction</span> <span class="o">-</span> <span class="n">test_labels</span><span class="p">,</span> <span class="s2">&quot;[n_rows, n_labels]&quot;</span><span class="p">)</span>
    <span class="n">square_error</span> <span class="o">=</span> <span class="n">check_shape</span><span class="p">(</span><span class="n">error</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;[n_rows, n_labels]&quot;</span><span class="p">)</span>
    <span class="n">mean_square_error</span> <span class="o">=</span> <span class="n">check_shape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">square_error</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;[n_rows]&quot;</span><span class="p">)</span>
    <span class="n">root_mean_square_error</span> <span class="o">=</span> <span class="n">check_shape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_square_error</span><span class="p">),</span> <span class="s2">&quot;[n_rows]&quot;</span><span class="p">)</span>
    <span class="n">loss</span><span class="p">:</span> <span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">root_mean_square_error</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span>

</pre></div>
</div>
</section>
<section id="checking-shapes-without-a-decorator">
<h2>Checking shapes without a decorator<a class="headerlink" href="#checking-shapes-without-a-decorator" title="Permalink to this heading">¶</a></h2>
<p>While the <a class="reference internal" href="autoapi/check_shapes/index.html#module-check_shapes" title="check_shapes"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_shapes()</span></code></a> decorator is the recommend way to use this library, it is possible to
use it without the decorator. In fact the decorator is just a wrapper around the class
<code class="xref py py-class docutils literal notranslate"><span class="pre">ShapeChecker</span></code>, which can be used to check shapes directly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="k">def</span> <span class="nf">linear_model</span><span class="p">(</span><span class="n">features</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
    <span class="n">checker</span> <span class="o">=</span> <span class="n">ShapeChecker</span><span class="p">()</span>
    <span class="n">checker</span><span class="o">.</span><span class="n">check_shape</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="s2">&quot;[batch..., n_features]&quot;</span><span class="p">)</span>
    <span class="n">checker</span><span class="o">.</span><span class="n">check_shape</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="s2">&quot;[n_features]&quot;</span><span class="p">)</span>
    <span class="n">prediction</span><span class="p">:</span> <span class="n">ndarray</span> <span class="o">=</span> <span class="n">checker</span><span class="o">.</span><span class="n">check_shape</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;...i,i -&gt; ...&quot;</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">weights</span><span class="p">),</span> <span class="s2">&quot;[batch...]&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">prediction</span>

</pre></div>
</div>
<p>You can use the function <code class="xref py py-func docutils literal notranslate"><span class="pre">get_shape_checker()</span></code> to get the <code class="xref py py-class docutils literal notranslate"><span class="pre">ShapeChecker</span></code> used by any
immediately surrounding <a class="reference internal" href="autoapi/check_shapes/index.html#module-check_shapes" title="check_shapes"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_shapes()</span></code></a> decorator.</p>
</section>
<section id="documenting-shapes">
<h2>Documenting shapes<a class="headerlink" href="#documenting-shapes" title="Permalink to this heading">¶</a></h2>
<p>The <a class="reference internal" href="autoapi/check_shapes/index.html#module-check_shapes" title="check_shapes"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_shapes()</span></code></a> decorator rewrites the docstring (<code class="docutils literal notranslate"><span class="pre">.__doc__</span></code>) of the decorated function
to add information about shapes, in a format compatible with
<a class="reference external" href="https://www.sphinx-doc.org/en/master/">Sphinx</a>.</p>
<p>Only functions that already have a docstring will be updated. Functions that have no docstring at
all will not have one added, this is so that we do not override a docstring that would have been
inherited from a super class.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;features: [batch..., n_features]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;weights: [n_features]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: [batch...]&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">linear_model</span><span class="p">(</span><span class="n">features</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes a prediction from a linear model.</span>

<span class="sd">    :param features: Data to make predictions from.</span>
<span class="sd">    :param weights: Model weights.</span>
<span class="sd">    :returns: Model predictions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prediction</span><span class="p">:</span> <span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;...i,i -&gt; ...&quot;</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prediction</span>

</pre></div>
</div>
<p>will have <code class="docutils literal notranslate"><span class="pre">.__doc__</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Computes a prediction from a linear model.</span>

<span class="sd">:param features:</span>
<span class="sd">    * **features** has shape [*batch*..., *n_features*].</span>

<span class="sd">    Data to make predictions from.</span>
<span class="sd">:param weights:</span>
<span class="sd">    * **weights** has shape [*n_features*].</span>

<span class="sd">    Model weights.</span>
<span class="sd">:returns:</span>
<span class="sd">    * **return** has shape [*batch*...].</span>

<span class="sd">    Model predictions.</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>if you do not wish to have your docstrings rewritten, you can disable it with
<code class="xref py py-func docutils literal notranslate"><span class="pre">set_rewrite_docstrings()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">set_rewrite_docstrings</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="supported-types">
<h2>Supported types<a class="headerlink" href="#supported-types" title="Permalink to this heading">¶</a></h2>
<p>This library has built-in support for checking the shapes of:</p>
<ul class="simple">
<li><p>Python built-in scalars: <code class="docutils literal notranslate"><span class="pre">bool</span></code>, <code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">float</span></code> and <code class="docutils literal notranslate"><span class="pre">str</span></code>.</p></li>
<li><p>Python built-in sequences: <code class="docutils literal notranslate"><span class="pre">tuple</span></code> and <code class="docutils literal notranslate"><span class="pre">list</span></code>.</p></li>
<li><p>NumPy <code class="docutils literal notranslate"><span class="pre">ndarray</span></code>s.</p></li>
<li><p>TensorFlow <code class="docutils literal notranslate"><span class="pre">Tensor</span></code>s and <code class="docutils literal notranslate"><span class="pre">Variable</span></code>s.</p></li>
<li><p>TensorFlow Probability <code class="docutils literal notranslate"><span class="pre">DeferredTensor</span></code>s, including <code class="docutils literal notranslate"><span class="pre">TransformedVariable</span></code>.</p></li>
<li><p>JAX <code class="docutils literal notranslate"><span class="pre">ndarray</span></code>s.</p></li>
<li><p>PyTorch <code class="docutils literal notranslate"><span class="pre">Tensor</span></code>s.</p></li>
</ul>
<section id="shapes-of-custom-types">
<h3>Shapes of custom types<a class="headerlink" href="#shapes-of-custom-types" title="Permalink to this heading">¶</a></h3>
<p><a class="reference internal" href="autoapi/check_shapes/index.html#module-check_shapes" title="check_shapes"><code class="xref py py-mod docutils literal notranslate"><span class="pre">check_shapes</span></code></a> uses the function <code class="xref py py-func docutils literal notranslate"><span class="pre">get_shape()</span></code> to extract the shape of an object.
<code class="xref py py-func docutils literal notranslate"><span class="pre">get_shape()</span></code> will try to read a property of the object with name <code class="docutils literal notranslate"><span class="pre">shape</span></code>, which should have
type <code class="docutils literal notranslate"><span class="pre">Optional[Tuple[Optional[int],</span> <span class="pre">...]]</span></code>. If you have a custom type that does not have such a
property you can use <code class="xref py py-func docutils literal notranslate"><span class="pre">register_get_shape()</span></code> to extend <code class="xref py py-func docutils literal notranslate"><span class="pre">get_shape()</span></code> to extract the shape of
your type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="k">class</span> <span class="nc">LinearModel</span><span class="p">:</span>
    <span class="nd">@check_shapes</span><span class="p">(</span>
        <span class="s2">&quot;weights: [n_features]&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="o">=</span> <span class="n">weights</span>

    <span class="nd">@check_shapes</span><span class="p">(</span>
        <span class="s2">&quot;self: [n_features]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;features: [batch..., n_features]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;return: [batch...]&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
        <span class="n">prediction</span><span class="p">:</span> <span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;...i,i -&gt; ...&quot;</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prediction</span>

<span class="nd">@register_get_shape</span><span class="p">(</span><span class="n">LinearModel</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_linear_model_shape</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">LinearModel</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ErrorContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Shape</span><span class="p">:</span>
    <span class="n">shape</span><span class="p">:</span> <span class="n">Shape</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_weights</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">return</span> <span class="n">shape</span>

<span class="nd">@check_shapes</span><span class="p">(</span>
    <span class="s2">&quot;model: [n_features]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;test_features: [n_rows, n_features]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;test_labels: [n_rows]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return: []&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">LinearModel</span><span class="p">,</span> <span class="n">test_features</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_features</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">prediction</span> <span class="o">-</span> <span class="n">test_labels</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))))</span>

</pre></div>
</div>
</section>
</section>
<section id="check-shapes-in-stack-traces">
<h2><cite>check_shapes</cite> in stack traces<a class="headerlink" href="#check-shapes-in-stack-traces" title="Permalink to this heading">¶</a></h2>
<p>If you use <a class="reference internal" href="autoapi/check_shapes/index.html#module-check_shapes" title="check_shapes"><code class="xref py py-mod docutils literal notranslate"><span class="pre">check_shapes</span></code></a> consistently you will have a lot of functions wrapped in
<a class="reference internal" href="autoapi/check_shapes/index.html#module-check_shapes" title="check_shapes"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_shapes()</span></code></a>. This means that if you have an error many of the stack frames in the trace
back would belong to <a class="reference internal" href="autoapi/check_shapes/index.html#module-check_shapes" title="check_shapes"><code class="xref py py-mod docutils literal notranslate"><span class="pre">check_shapes</span></code></a>. For the sake of more readable error messages
<a class="reference internal" href="autoapi/check_shapes/index.html#module-check_shapes" title="check_shapes"><code class="xref py py-mod docutils literal notranslate"><span class="pre">check_shapes</span></code></a> has code to hide itself from trace backs. If you do not like this you can
disable this behaviour with <code class="xref py py-func docutils literal notranslate"><span class="pre">set_drop_frames()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">set_drop_frames</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="#">check_shapes</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="benchmarks.html">Benchmark results</a></li>
<li class="toctree-l1"><a class="reference internal" href="autoapi/check_shapes/index.html">API reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="#">Documentation overview</a><ul>
      <li>Next: <a href="benchmarks.html" title="next chapter">Benchmark results</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, The GPflow Contributors.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="_sources/index.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>